<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cjw.project.code.dao.testDAO">
	<resultMap type="testPO" id="testResultMap">
		<result property="callerno" column="callerno" />
		<result property="times" column="times" />
		<result property="devicetype" column="devicetype" />
		<result property="waitbegin" column="waitbegin" />
	</resultMap>
	<select id="queryInfo" resultMap="testResultMap" resultType="testPO">
		<!-- SELECT aa.callerno, aa.waitbegin, aa.devicetype FROM TBILLLOG072 aa 
			WHERE aa.calleeno = '12345' AND aa.callerno NOT IN ( SELECT callerno FROM 
			smart_queue_exclude_callerno ) ORDER BY aa.callerno DESC, aa.waitbegin ASC -->
	<!-- SELECT aa.callid callerno, aa.waitbegin, aa.devicetype, time_to_sec(timediff(cc.callend, 
		cc.callbegin)) times FROM TBILLLOG072 aa WHERE aa.calleeno = '12345' AND 
		aa.callerno NOT IN ( SELECT callerno FROM smart_queue_exclude_callerno ) 
		ORDER BY aa.callerno DESC, aa.callid desc, aa.waitbegin ASC -->
		
SELECT
	bb.callerno,
	bb.waitbegin,
	bb.devicetype
FROM
	(
		SELECT
			aa.callerno,
			aa.waitbegin,
			aa.devicetype,
			time_to_sec(
				timediff(aa.callend, aa.callbegin)
			) times
		FROM
			TBILLLOG072 aa
		WHERE
			aa.calleeno = '12345'
		AND aa.callerno NOT IN (
			SELECT
				callerno
			FROM
				smart_queue_exclude_callerno
		)
		ORDER BY
			aa.callerno DESC,
			aa.callid DESC,
			aa.waitbegin DESC
	) bb
WHERE
	bb.devicetype = 1
OR bb.devicetype = 3
OR (
	bb.times > 0 and bb.devicetype = 2
)
ORDER BY
			bb.callerno DESC,
			bb.waitbegin asc
		
	</select>
	<select id="queryinhtime" resultMap="testResultMap" resultType="testPO">
		SELECT
			time_to_sec(
				timediff(aa.waitend, aa.waitbegin)
			) times,
			aa.callid callerno,
			devicetype,waitbegin
		FROM
			TBILLLOG072 aa
		WHERE
			aa.calleeno = '12345'
		AND (
			aa.devicetype = 1
			OR (
				devicetype = 2
				AND time_to_sec(timediff(aa.callend, aa.callbegin)) > 1
			)
		)
		ORDER BY
			aa.callid,aa.waitbegin
	</select>
</mapper>  